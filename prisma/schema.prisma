generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  DESIGNER
  BUYER
  TECHDESIGN
  SOURCING
}

enum ProductStatus {
  DRAFT
  IN_REVIEW
  APPROVED
  IN_PRODUCTION
  COMPLETED
  CANCELLED
}

enum MaterialType {
  FABRIC
  TRIM
  PACKAGING
  OTHER
  BUTTON
  ZIPPER
  WAPPEN
  YARN
  HANG_TAG
  PACKING
}

enum MaterialCategory {
  MAIN_FABRIC
  SUB_FABRIC
  SUB_MATERIAL
  TRIM
}

enum SampleType {
  PROTO
  SALES_SAMPLE
  PP_SAMPLE
  TOP
  OTHER
}

enum SampleStatus {
  PENDING
  IN_PROGRESS
  SUBMITTED
  APPROVED
  REJECTED
}

enum SampleMaterialKind {
  MAIN_FABRIC
  SUB_FABRIC
  SUB_MATERIAL
}

enum CostStatus {
  ESTIMATING
  QUOTED
  NEGOTIATING
  APPROVED
  REJECTED
}

enum ColorType {
  SOLID
  PATTERN
}

model UserMaster {
  id        String    @id @default(cuid())
  userid    String    @unique
  email     String?
  password  String
  name      String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  userRole  UserRole?
}

model UserRole {
  id        String     @id @default(cuid())
  userId    String     @unique
  user      UserMaster @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      Role
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model SeasonMaster {
  id           String       @id @default(cuid())
  name         String       @unique
  seasonCode   Int          @unique
  seasonName   String       // SS, FW
  description  String?
  startDate    DateTime?
  endDate      DateTime?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  collections  Collection[]
  trendItems   TrendItem[]
  samples      Sample[]
}

model Collection {
  id          String    @id @default(cuid())
  name        String
  description String?
  seasonId    String
  season      SeasonMaster @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  products    Product[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Product {
  id           String        @id @default(cuid())
  styleNumber  String        @unique
  name         String
  divisionId   Int?
  division     DivisionMaster? @relation(fields: [divisionId], references: [id], onDelete: SetNull)
  category     String
  description  String?
  status       ProductStatus @default(DRAFT)
  targetPrice  Float?
  salesStart   DateTime?
  originalPrice Float?
  planQty      Int?
  collectionId String?
  collection   Collection?   @relation(fields: [collectionId], references: [id], onDelete: SetNull)
  supplierId   String?
  supplier     Supplier?     @relation(fields: [supplierId], references: [id], onDelete: SetNull)
  samples      Sample[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model DivisionMaster {
  id           Int         @id
  name         String      @unique
  divisionCode Int         @unique @default(0)
  products     Product[]
  sizeGroups   SizeGroup[]
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
}

model Material {
  id                String             @id @default(cuid())
  materialCode      String?
  name              String
  type              MaterialType       @default(FABRIC)
  materialCategory  MaterialCategory?
  composition       String?
  color             String?            // legacy - use materialColors instead
  weight            String?
  width             String?
  unitPrice         Float?
  unit              String?            // m, yard, pcs, etc.
  description       String?
  imageUrl          String?            // base64 data URL
  originCountry     String?
  docs              Json?              // Array of { name: string, url: string }
  bomItems          BomItem[]
  supplierMaterials SupplierMaterial[]
  materialColors    MaterialColor[]
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
}

model MaterialColor {
  id         String   @id @default(cuid())
  materialId String
  material   Material @relation(fields: [materialId], references: [id], onDelete: Cascade)
  colorId    String
  color      Color    @relation(fields: [colorId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@unique([materialId, colorId])
}

model BomItem {
  id         String   @id @default(cuid())
  sampleId   String
  sample     Sample   @relation(fields: [sampleId], references: [id], onDelete: Cascade)
  materialId String
  material   Material @relation(fields: [materialId], references: [id], onDelete: Cascade)
  quantity   Float
  unit       String?
  note       String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([sampleId, materialId])
}

model Supplier {
  id                String             @id @default(cuid())
  name              String
  contactPerson     String?
  email             String?
  phone             String?
  address           String?
  country           String?
  description       String?
  products          Product[]
  samples           Sample[]
  supplierMaterials SupplierMaterial[]
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
}

model SupplierMaterial {
  id         String   @id @default(cuid())
  supplierId String
  supplier   Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  materialId String
  material   Material @relation(fields: [materialId], references: [id], onDelete: Cascade)
  leadTime   Int?     // days
  moq        Int?     // minimum order quantity
  unitPrice  Float?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([supplierId, materialId])
}

model Sample {
  id                  String       @id @default(cuid())
  sampleName          String
  sampleNumber        String       @unique
  sampleType          SampleType   @default(PROTO)
  status              SampleStatus @default(PENDING)
  sizeSpec            String?
  remarks             String?
  imageUrl            String?
  mainFactoryCode     String?
  dueDate             DateTime?
  shippingDestination String?
  fittingComment      String?
  year                Int?
  salesStart          DateTime?
  poDeadline          DateTime?
  originalPrice       Float?
  planQty             Int?
  seasonId            String?
  season              SeasonMaster? @relation(fields: [seasonId], references: [id], onDelete: SetNull)
  division            String?
  subCategory         String?
  supplierId          String?
  supplier            Supplier?    @relation(fields: [supplierId], references: [id], onDelete: SetNull)
  illustratorFile     String?
  patternCadFile      String?
  clo3dFile           String?
  clo3dFileName       String?
  productOverride     String?
  productId           String
  product             Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
  bomItems            BomItem[]
  costs               Cost[]
  sampleColors        SampleColor[]
  sizeMeasurements    SampleMeasurement[]
  sampleMaterials     SampleMaterial[]
  milestoneProgresses SampleMilestoneProgress[]
  comments            SampleComment[]
  qualityInspections  QualityInspection[]
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
}

model Cost {
  id             String     @id @default(cuid())
  costVersion    String
  status         CostStatus @default(ESTIMATING)
  currency       String     @default("USD")
  fobPrice       Decimal?   @db.Decimal(10, 2)
  materialCost   Decimal?   @db.Decimal(10, 2)
  processingCost Decimal?   @db.Decimal(10, 2)
  trimCost       Decimal?   @db.Decimal(10, 2)
  profitMargin   Float?
  moq            Int?
  leadTimeDays   Int?
  remarks        String?
  sampleId       String
  sample         Sample     @relation(fields: [sampleId], references: [id], onDelete: Cascade)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
}

model TrendItem {
  id          String   @id @default(cuid())
  title       String
  url         String?
  imageUrl    String?
  description String?
  tags        String[] @default([])
  seasonId    String?
  season      SeasonMaster? @relation(fields: [seasonId], references: [id], onDelete: SetNull)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Color {
  id               String    @id @default(cuid())
  colorCode        String
  colorName        String
  pantoneCode      String?
  pantoneName      String?
  rgbValue         String?
  colorImage       String?
  colorType        ColorType @default(SOLID)
  cmykC            Int?      // 0-100
  cmykM            Int?      // 0-100
  cmykY            Int?      // 0-100
  cmykK            Int?      // 0-100
  colorTemperature String?   // COOL | WARM | NEUTRAL
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  samples        SampleColor[]
  materialColors MaterialColor[]

  @@index([colorCode])
  @@index([colorName])
  @@index([pantoneCode])
}

model SampleColor {
  id        String   @id @default(cuid())
  sampleId  String
  sample    Sample   @relation(fields: [sampleId], references: [id], onDelete: Cascade)
  colorId   String
  color     Color    @relation(fields: [colorId], references: [id], onDelete: Cascade)
  status    String   @default("IN_PROGRESS")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sampleId, colorId])
  @@index([colorId])
}

model SizeGroup {
  id          String       @id @default(cuid())
  name        String
  divisionId  Int
  division    DivisionMaster @relation(fields: [divisionId], references: [id])
  subCategory String?
  isActive    Boolean      @default(true)
  sortOrder   Int          @default(0)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  sizes       SizeMaster[]

  @@unique([divisionId, name])
  @@index([divisionId, sortOrder])
  @@index([divisionId, subCategory])
}

model SizeMaster {
  id           String     @id @default(cuid())
  sizeGroupId  String
  sizeGroup    SizeGroup  @relation(fields: [sizeGroupId], references: [id], onDelete: Cascade)
  sizeCode     String
  sizeName     String     @default("")
  sortOrder    Int        @default(0)
  isActive     Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  measurements SampleMeasurement[]

  @@unique([sizeGroupId, sizeCode])
  @@index([sizeGroupId, sortOrder])
}

model SampleMeasurement {
  id           String      @id @default(cuid())
  sampleId     String
  sample       Sample      @relation(fields: [sampleId], references: [id], onDelete: Cascade)
  sizeMasterId String?
  sizeMaster   SizeMaster? @relation(fields: [sizeMasterId], references: [id], onDelete: SetNull)
  sizeCode     String
  part         String
  value        String
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@index([sampleId, sizeCode])
  @@index([sizeMasterId])
}

model SampleMaterial {
  id            String             @id @default(cuid())
  sampleId      String
  sample        Sample             @relation(fields: [sampleId], references: [id], onDelete: Cascade)
  kind          SampleMaterialKind
  materialCode  String?
  materialName  String?
  costPerUnit   Float?
  fabricSupplier String?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  @@index([sampleId, kind])
}

model Milestone {
  id          String                  @id @default(cuid())
  name        String
  description String?
  sortOrder   Int                     @default(0)
  isActive    Boolean                 @default(true)
  progresses  SampleMilestoneProgress[]
  schedules   ScheduleMilestoneAssignment[]
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt
}

model SampleMilestoneProgress {
  id          String    @id @default(cuid())
  sampleId    String
  sample      Sample    @relation(fields: [sampleId], references: [id], onDelete: Cascade)
  milestoneId String
  milestone   Milestone @relation(fields: [milestoneId], references: [id], onDelete: Cascade)
  completed   Boolean   @default(false)
  completedAt DateTime?
  note        String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([sampleId, milestoneId])
  @@index([milestoneId])
}

model Schedule {
  id          String                        @id @default(cuid())
  scheduleDate DateTime                     @db.Date
  note        String?
  milestones  ScheduleMilestoneAssignment[]
  createdAt   DateTime                      @default(now())
  updatedAt   DateTime                      @updatedAt

  @@unique([scheduleDate])
}

model ScheduleMilestoneAssignment {
  id          String     @id @default(cuid())
  scheduleId  String
  schedule    Schedule   @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  milestoneId String
  milestone   Milestone  @relation(fields: [milestoneId], references: [id], onDelete: Cascade)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@unique([scheduleId, milestoneId])
  @@index([milestoneId])
}

// ── WSSI / OTB Planning ──────────────────────────

model OtbPlanning {
  id              String   @id @default(cuid())
  styleNumber     String
  styleName       String   @default("")
  category        String   @default("")
  season          Int      @default(1)
  divisionName    String   @default("")
  totalPlanQty    Int      @default(0)
  weekNumber      Int
  year            Int
  salesQty        Int      @default(0)
  storeInvQty     Int      @default(0)
  whInvQty        Int      @default(0)
  intakeQty       Int      @default(0)
  otb             Int      @default(0)
  salesStartDate  DateTime? @db.Date
  finalAllocDate  DateTime? @db.Date
  salesEndDate    DateTime? @db.Date
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([styleNumber, weekNumber, year])
  @@index([year])
  @@index([styleNumber])
}

// ── Merchandize Financial Planning ───────────────

model FinancialPlanning {
  id          String   @id @default(cuid())
  year        Int
  seasonCode  Int      @default(1)
  divisionName String  @default("")
  month       Int
  revenue     Float    @default(0)
  gmPercent   Float    @default(0)
  ebita       Float    @default(0)
  inventory   Float    @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([year, seasonCode, divisionName, month])
  @@index([year, seasonCode])
}

// ── Product Review (from Ozon) ───────────────────

model ProductReview {
  id              String   @id @default(cuid())
  reviewId        String   @unique // Original: ID Отзыва
  sku             String   // Original: SKU
  articleNumber   String   // Original: Артикул
  productName     String   // Original: Название товара
  reviewText      String?  @db.Text // Original: Текст отзыва
  publishedAt     DateTime // Original: Дата публикации отзыва
  rating          Int      // Original: Рейтинг (1-5)
  status          String   // Original: Статус (UNPROCESSED, etc)
  commentCount    Int      @default(0) // Original: Количество комментариев у отзыва
  orderStatus     String   // Original: Статус заказа (DELIVERED, etc)
  ratingMember    Boolean  @default(false) // Original: Участник рейтинга
  channel         String   @default("OZON") // Sales channel (OZON, etc)
  summaryEn       String?  // AI-generated English summary
  tags            String[] @default([]) // AI-generated classification tags
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([sku])
  @@index([articleNumber])
  @@index([rating])
  @@index([publishedAt])
  @@index([channel])
}

// ── Sample Comments ─────────────────────────────

model SampleComment {
  id          String   @id @default(cuid())
  sampleId    String
  sample      Sample   @relation(fields: [sampleId], references: [id], onDelete: Cascade)
  userId      String   // User who made the comment
  userName    String   // User's display name
  comment     String   @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([sampleId])
  @@index([createdAt])
}

// ── Quality Management ──────────────────────────

enum QualityInspectionStatus {
  DRAFT
  IN_PROGRESS
  COMPLETED
  APPROVED
  REJECTED
}

enum QualityResult {
  PASS
  FAIL
  CONDITIONAL
  NOT_TESTED
}

enum CareLabelCategory {
  WASHING
  BLEACHING
  DRYING
  IRONING
  DRY_CLEANING
  ADDITIONAL
}

model QualityInspection {
  id              String                   @id @default(cuid())
  sampleId        String
  sample          Sample                   @relation(fields: [sampleId], references: [id], onDelete: Cascade)
  inspectionType  String                   @default("FINAL")    // INLINE, FINAL, PRE_PRODUCTION
  inspectionDate  DateTime?
  inspector       String?
  overallResult   QualityResult            @default(NOT_TESTED)
  status          QualityInspectionStatus  @default(DRAFT)
  remarks         String?                  @db.Text
  items           QualityInspectionItem[]
  photos          QualityPhoto[]
  careLabels      QualityCareLabel[]
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt

  @@index([sampleId])
  @@index([status])
}

model QualityInspectionItem {
  id              String              @id @default(cuid())
  inspectionId    String
  inspection      QualityInspection   @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  category        String              // e.g. "Appearance", "Measurement", "Colorfastness", "Seam Strength"
  itemName        String              // e.g. "Seam allowance", "Fabric weight"
  standard        String?             // Expected standard / tolerance
  actualValue     String?             // Measured / observed value
  result          QualityResult       @default(NOT_TESTED)
  remarks         String?
  sortOrder       Int                 @default(0)
  isAiGenerated   Boolean             @default(false)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([inspectionId])
  @@index([category])
}

model QualityPhoto {
  id              String            @id @default(cuid())
  inspectionId    String
  inspection      QualityInspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  imageUrl        String
  caption         String?
  photoType       String            @default("GENERAL") // GENERAL, DEFECT, MEASUREMENT, LABEL
  sortOrder       Int               @default(0)
  createdAt       DateTime          @default(now())

  @@index([inspectionId])
}

model QualityCareLabel {
  id              String            @id @default(cuid())
  inspectionId    String
  inspection      QualityInspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  category        CareLabelCategory
  symbolCode      String            // ISO 3758 code e.g. "CL-001"
  symbolName      String            // e.g. "Machine Wash 40°C"
  symbolSvg       String?           @db.Text  // SVG markup for the symbol
  description     String?           // Additional text description
  sortOrder       Int               @default(0)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([inspectionId])
  @@index([category])
}
